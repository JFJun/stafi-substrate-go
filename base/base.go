package base

import (
	"encoding/hex"
	"encoding/json"
	"errors"
	"fmt"
	"io/ioutil"
	"math/big"
	"strings"
)

/*
币种基本配置类型
https://github.com/paritytech/substrate/blob/master/ss58-registry.json
*/
type BasicTypes struct {
	Specification string            `json:"specification"`
	Schema        map[string]string `json:"schema"`
	Registry      []ChainRegistry   `json:"registry"`
}

type ChainRegistry struct {
	Prefix          int64    `json:"prefix"`
	Network         string   `json:"network"`
	DisplayName     string   `json:"displayName"`
	Symbols         []string `json:"symbols"`
	Decimals        []int    `json:"decimals"`
	StandardAccount string   `json:"standardAccount"`
	Website         string   `json:"website"`
}

func InitBasicTypes(filePath string) (*BasicTypes, error) {
	if filePath == "" {
		filePath = "ss58-registry.json"
	}
	cc, err := ioutil.ReadFile(filePath)
	if err != nil {
		return nil, fmt.Errorf("read json file error: %v", err)
	}
	//fmt.Println(hex.EncodeToString(cc))
	var bt BasicTypes
	err = json.Unmarshal(cc, &bt)
	if err != nil {
		return nil, fmt.Errorf("json unmarshal Basic type error: %v", err)
	}
	return &bt, nil
}

func InitBasicTypesByHexData() (*BasicTypes, error) {
	hexData := strings.TrimPrefix(typesHexData, "0x")
	cc, err := hex.DecodeString(hexData)
	if err != nil {
		return nil, err
	}
	var bt BasicTypes
	err = json.Unmarshal(cc, &bt)
	if err != nil {
		return nil, fmt.Errorf("json unmarshal Basic type error: %v", err)
	}
	return &bt, nil
}

func (bt *BasicTypes) GetChainDecimal(chainName string) (int, error) {
	if len(bt.Registry) == 0 {
		return -1, fmt.Errorf("do not set base type registry")
	}
	for _, reg := range bt.Registry {
		if strings.ToLower(reg.Network) == strings.ToLower(chainName) {
			if len(reg.Decimals) != 0 {
				return reg.Decimals[0], nil
			}
		}
	}
	return -1, errors.New("do not find this chain decimal")
}

var defaultPrefix = []byte{0x2a}

/*
错误时返回默认的prefix
*/
func (bt *BasicTypes) GetChainPrefix(chainName string) ([]byte, error) {
	if len(bt.Registry) == 0 {
		return defaultPrefix, fmt.Errorf("do not set base type registry")
	}
	for _, reg := range bt.Registry {
		if strings.ToLower(reg.Network) == strings.ToLower(chainName) {
			return big.NewInt(reg.Prefix).Bytes(), nil
		}
	}
	return defaultPrefix, errors.New("do not find this chain decimal")
}

var typesHexData string = "0x7b0a20202273706563696669636174696f6e223a202268747470733a2f2f6769746875622e636f6d2f706172697479746563682f7375627374726174652f77696b692f45787465726e616c2d416464726573732d466f726d61742d285353353829222c0a202022736368656d61223a207b0a2020202022707265666978223a20225468652061646472657373207072656669782e204d75737420626520616e20696e746567657220616e6420756e697175652e222c0a20202020226e6574776f726b223a2022556e69717565206964656e74696669657220666f7220746865206e6574776f726b20746861742077696c6c207573652074686973207072656669782c20737472696e672c206e6f207370616365732e20546f20696e74656772617465207769746820434c4920746f6f6c732c20652e672e20602d2d6e6574776f726b20706f6c6b61646f74602e222c0a2020202022646973706c61794e616d65223a2022546865206e616d65206f6620746865206e6574776f726b20746861742077696c6c207573652074686973207072656669782c20696e206120666f726d617420667269656e646c7920666f7220646973706c61792e222c0a202020202273796d626f6c73223a20224172726179206f662073796d626f6c73206f6620616e7920746f6b656e732074686520636861696e20757365732c20757375616c6c7920322d3520636861726163746572732e204d6f737420636861696e732077696c6c206f6e6c792068617665206f6e652e20436861696e7320746861742068617665206d756c7469706c6520696e7374616e636573206f66207468652042616c616e6365732070616c6c65742073686f756c64206f726465722074686520617272617920627920696e7374616e63652e222c0a2020202022646563696d616c73223a20224172726179206f6620696e74656765727320726570726573656e74696e6720746865206e756d626572206f6620646563696d616c73207468617420726570726573656e7420612073696e676c6520756e697420746f2074686520656e6420757365722e204d7573742062652073616d65206c656e677468206173206073796d626f6c736020746f20726570726573656e74206561636820746f6b656e27732064656e6f6d696e6174696f6e2e222c0a20202020227374616e646172644163636f756e74223a20225369676e696e6720637572766520666f72207374616e64617264206163636f756e742e2053756273747261746520737570706f72747320656432353531392c20737232353531392c20616e6420736563703235366b312e222c0a202020202277656273697465223a2022412077656273697465206f7220476974687562207265706f206173736f636961746564207769746820746865206e6574776f726b2e220a20207d2c0a2020227265676973747279223a205b0a202020207b0a20202020202022707265666978223a20302c0a202020202020226e6574776f726b223a2022706f6c6b61646f74222c0a20202020202022646973706c61794e616d65223a2022506f6c6b61646f742052656c617920436861696e222c0a2020202020202273796d626f6c73223a205b22444f54225d2c0a20202020202022646563696d616c73223a205b31305d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f706f6c6b61646f742e6e6574776f726b220a202020207d2c0a202020207b0a20202020202022707265666978223a20312c0a202020202020226e6574776f726b223a2022726573657276656431222c0a20202020202022646973706c61794e616d65223a202254686973207072656669782069732072657365727665642e222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a206e756c6c2c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a20322c0a202020202020226e6574776f726b223a20226b7573616d61222c0a20202020202022646973706c61794e616d65223a20224b7573616d612052656c617920436861696e222c0a2020202020202273796d626f6c73223a205b224b534d225d2c0a20202020202022646563696d616c73223a205b31325d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6b7573616d612e6e6574776f726b220a202020207d2c0a202020207b0a20202020202022707265666978223a20332c0a202020202020226e6574776f726b223a2022726573657276656433222c0a20202020202022646973706c61794e616d65223a202254686973207072656669782069732072657365727665642e222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a206e756c6c2c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a20342c0a202020202020226e6574776f726b223a20226b6174616c636861696e222c0a20202020202022646973706c61794e616d65223a20224b6174616c20436861696e222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a20352c0a202020202020226e6574776f726b223a2022706c61736d222c0a20202020202022646973706c61794e616d65223a2022506c61736d204e6574776f726b222c0a2020202020202273796d626f6c73223a205b22504c4d225d2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a20362c0a202020202020226e6574776f726b223a2022626966726f7374222c0a20202020202022646973706c61794e616d65223a2022426966726f7374222c0a2020202020202273796d626f6c73223a205b22424e43225d2c0a20202020202022646563696d616c73223a205b31325d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f626966726f73742e66696e616e63652f220a202020207d2c0a202020207b0a20202020202022707265666978223a20372c0a202020202020226e6574776f726b223a20226564676577617265222c0a20202020202022646973706c61794e616d65223a20224564676577617265222c0a2020202020202273796d626f6c73223a205b22454447225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6564676577612e7265220a202020207d2c0a202020207b0a20202020202022707265666978223a20382c0a202020202020226e6574776f726b223a20226b6172757261222c0a20202020202022646973706c61794e616d65223a20224163616c61204b61727572612043616e617279222c0a2020202020202273796d626f6c73223a205b224b4152225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6163616c612e6e6574776f726b2f220a202020207d2c0a202020207b0a20202020202022707265666978223a20392c0a202020202020226e6574776f726b223a20227265796e6f6c6473222c0a20202020202022646973706c61794e616d65223a20224c616d696e6172205265796e6f6c64732043616e617279222c0a2020202020202273796d626f6c73223a205b22524559225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a2022687474703a2f2f6c616d696e61722e6e6574776f726b2f220a202020207d2c0a202020207b0a20202020202022707265666978223a2031302c0a202020202020226e6574776f726b223a20226163616c61222c0a20202020202022646973706c61794e616d65223a20224163616c61222c0a2020202020202273796d626f6c73223a205b22414341225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6163616c612e6e6574776f726b2f220a202020207d2c0a202020207b0a20202020202022707265666978223a2031312c0a202020202020226e6574776f726b223a20226c616d696e6172222c0a20202020202022646973706c61794e616d65223a20224c616d696e6172222c0a2020202020202273796d626f6c73223a205b224c414d49225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a2022687474703a2f2f6c616d696e61722e6e6574776f726b2f220a202020207d2c0a202020207b0a20202020202022707265666978223a2031322c0a202020202020226e6574776f726b223a2022706f6c796d617468222c0a20202020202022646973706c61794e616d65223a2022506f6c796d617468222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2031332c0a202020202020226e6574776f726b223a202273756273747261746565222c0a20202020202022646973706c61794e616d65223a202253756273747261544545222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f7777772e737562737472617465652e636f6d220a202020207d2c0a202020207b0a20202020202022707265666978223a2031342c0a202020202020226e6574776f726b223a2022746f74656d222c0a20202020202022646973706c61794e616d65223a2022546f74656d222c0a2020202020202273796d626f6c73223a205b22585458225d2c0a20202020202022646563696d616c73223a205b305d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f746f74656d6163636f756e74696e672e636f6d220a202020207d2c0a202020207b0a20202020202022707265666978223a2031352c0a202020202020226e6574776f726b223a202273796e6573746865736961222c0a20202020202022646973706c61794e616d65223a202253796e6573746865736961222c0a2020202020202273796d626f6c73223a205b2253594e225d2c0a20202020202022646563696d616c73223a205b31325d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f73796e65737468657369612e6e6574776f726b2f220a202020207d2c0a202020207b0a20202020202022707265666978223a2031362c0a202020202020226e6574776f726b223a20226b756c757075222c0a20202020202022646973706c61794e616d65223a20224b756c757075222c0a2020202020202273796d626f6c73223a205b224b4c50225d2c0a20202020202022646563696d616c73223a205b31325d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6b756c7570752e6e6574776f726b2f220a202020207d2c0a202020207b0a20202020202022707265666978223a2031372c0a202020202020226e6574776f726b223a20226461726b222c0a20202020202022646973706c61794e616d65223a20224461726b204d61696e6e6574222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2031382c0a202020202020226e6574776f726b223a202264617277696e6961222c0a20202020202022646973706c61794e616d65223a202244617277696e6961204e6574776f726b222c0a2020202020202273796d626f6c73223a205b2252494e47222c20224b544f4e225d2c0a20202020202022646563696d616c73223a205b392c20395d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f64617277696e69612e6e6574776f726b2f220a202020207d2c0a202020207b0a20202020202022707265666978223a2031392c0a202020202020226e6574776f726b223a20226765656b222c0a20202020202022646973706c61794e616d65223a20224765656b43617368222c0a2020202020202273796d626f6c73223a205b224745454b225d2c0a20202020202022646563696d616c73223a205b31325d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6765656b636173682e6f7267220a202020207d2c0a202020207b0a20202020202022707265666978223a2032302c0a202020202020226e6574776f726b223a20227374616669222c0a20202020202022646973706c61794e616d65223a20225374616669222c0a2020202020202273796d626f6c73223a205b22464953225d2c0a20202020202022646563696d616c73223a205b31325d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f73746166692e696f220a202020207d2c0a202020207b0a20202020202022707265666978223a2032312c0a202020202020226e6574776f726b223a2022646f636b2d746573746e6574222c0a20202020202022646973706c61794e616d65223a2022446f636b20546573746e6574222c0a2020202020202273796d626f6c73223a205b2244434b225d2c0a20202020202022646563696d616c73223a205b365d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f646f636b2e696f220a202020207d2c0a202020207b0a20202020202022707265666978223a2032322c0a202020202020226e6574776f726b223a2022646f636b2d6d61696e6e6574222c0a20202020202022646973706c61794e616d65223a2022446f636b204d61696e6e6574222c0a2020202020202273796d626f6c73223a205b2244434b225d2c0a20202020202022646563696d616c73223a205b365d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f646f636b2e696f220a202020207d2c0a202020207b0a20202020202022707265666978223a2032332c0a202020202020226e6574776f726b223a20227368696674222c0a20202020202022646973706c61794e616d65223a202253686966744e7267222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2032342c0a202020202020226e6574776f726b223a20227a65726f222c0a20202020202022646973706c61794e616d65223a20225a45524f222c0a2020202020202273796d626f6c73223a205b22504c4159225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f7a65726f2e696f220a202020207d2c0a202020207b0a20202020202022707265666978223a2032352c0a202020202020226e6574776f726b223a20227a65726f2d616c70686176696c6c65222c0a20202020202022646973706c61794e616d65223a20225a45524f20416c70686176696c6c65222c0a2020202020202273796d626f6c73223a205b22504c4159225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f7a65726f2e696f220a202020207d2c0a202020207b0a20202020202022707265666978223a2032382c0a202020202020226e6574776f726b223a2022737562736f6369616c222c0a20202020202022646973706c61794e616d65223a2022537562736f6369616c222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2033302c0a202020202020226e6574776f726b223a20227068616c61222c0a20202020202022646973706c61794e616d65223a20225068616c61204e6574776f726b222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2033322c0a202020202020226e6574776f726b223a2022726f626f6e6f6d696373222c0a20202020202022646973706c61794e616d65223a2022526f626f6e6f6d696373204e6574776f726b222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2033332c0a202020202020226e6574776f726b223a20226461746168696768776179222c0a20202020202022646973706c61794e616d65223a20224461746148696768776179222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2033362c0a202020202020226e6574776f726b223a202263656e74726966756765222c0a20202020202022646973706c61794e616d65223a202243656e7472696675676520436861696e222c0a2020202020202273796d626f6c73223a205b22524144225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f63656e747269667567652e696f2f220a202020207d2c0a202020207b0a20202020202022707265666978223a2033372c0a202020202020226e6574776f726b223a20226e6f646c65222c0a20202020202022646973706c61794e616d65223a20224e6f646c6520436861696e222c0a2020202020202273796d626f6c73223a205b224e4f444c225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6e6f646c652e696f2f220a202020207d2c0a202020207b0a20202020202022707265666978223a2033392c0a202020202020226e6574776f726b223a20226d617468636861696e222c0a20202020202022646973706c61794e616d65223a20224d617468436861696e206d61696e6e6574222c0a2020202020202273796d626f6c73223a205b224d415448225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6d61746877616c6c65742e6f7267220a202020207d2c0a202020207b0a20202020202022707265666978223a2034302c0a202020202020226e6574776f726b223a20226d617468636861696e2d746573746e6574222c0a20202020202022646973706c61794e616d65223a20224d617468436861696e20746573746e6574222c0a2020202020202273796d626f6c73223a205b224d415448225d2c0a20202020202022646563696d616c73223a205b31385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f6d61746877616c6c65742e6f7267220a202020207d2c0a202020207b0a20202020202022707265666978223a2034322c0a202020202020226e6574776f726b223a2022737562737472617465222c0a20202020202022646973706c61794e616d65223a2022537562737472617465222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f7375627374726174652e6465762f220a202020207d2c0a202020207b0a20202020202022707265666978223a2034332c0a202020202020226e6574776f726b223a202272657365727665643433222c0a20202020202022646973706c61794e616d65223a202254686973207072656669782069732072657365727665642e222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a206e756c6c2c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2034342c0a202020202020226e6574776f726b223a2022636861696e78222c0a20202020202022646973706c61794e616d65223a2022436861696e58222c0a2020202020202273796d626f6c73223a205b22504358225d2c0a20202020202022646563696d616c73223a205b385d2c0a202020202020227374616e646172644163636f756e74223a20222a3235353139222c0a2020202020202277656273697465223a202268747470733a2f2f636861696e782e6f72672f220a202020207d2c0a202020207b0a20202020202022707265666978223a2034362c0a202020202020226e6574776f726b223a202272657365727665643436222c0a20202020202022646973706c61794e616d65223a202254686973207072656669782069732072657365727665642e222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a206e756c6c2c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2034372c0a202020202020226e6574776f726b223a202272657365727665643437222c0a20202020202022646973706c61794e616d65223a202254686973207072656669782069732072657365727665642e222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a206e756c6c2c0a2020202020202277656273697465223a206e756c6c0a202020207d2c0a202020207b0a20202020202022707265666978223a2034382c0a202020202020226e6574776f726b223a202272657365727665643438222c0a20202020202022646973706c61794e616d65223a2022416c6c20707265666978657320343820616e64206869676865722061726520726573657276656420616e642063616e6e6f7420626520616c6c6f63617465642e222c0a2020202020202273796d626f6c73223a206e756c6c2c0a20202020202022646563696d616c73223a206e756c6c2c0a202020202020227374616e646172644163636f756e74223a206e756c6c2c0a2020202020202277656273697465223a206e756c6c0a202020207d0a20205d0a7d"
